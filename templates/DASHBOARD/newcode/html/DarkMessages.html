{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Dark Messages</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="{% static 'DASHBOARD/CSS/DarkMessages.css' %}" rel="stylesheet">
  <style>
    .user-avatar { width: 35px; height: 35px; border-radius: 50%; }
    .token-badge { background-color: #0d6efd; color: white; padding: 2px 6px; border-radius: 4px; }
    .participant-card { text-align: center; }
    .search-highlight { background-color: yellow; font-weight: bold; }
    .chat-container { padding: 10px; }
    .message-bubble { padding: 8px 12px; border-radius: 10px; margin: 5px 0; max-width: 75%; }
    .sent { background-color: #d1e7dd; margin-left: auto; }
    .received { background-color: #f8d7da; margin-right: auto; }
    .no-messages { color: #6c757d; }
    .chat-header { font-weight: bold; margin-bottom: 8px; }

    /*** new one ***/
        :root {
      --primary-dark: #3a0ca3;
      --primary: #4361ee;
      --danger: #f72585;
      --dark: #212529;
      --dark-bg: #1a1a2e;
      --dark-card: #16213e;
    }
    
    body {
      background-color: #f8f9fa;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .darkroom-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
      border-left: 4px solid var(--primary-dark);
    }
    
    .darkroom-header {
      background-color: var(--primary-dark);
      color: white;
      border-radius: 10px 10px 0 0;
      padding: 15px 20px;
    }
    
    .darkroom-table th {
      background-color: #f1f3f9;
      font-weight: 600;
      color: var(--dark);
    }
    
    .token-badge {
      font-family: 'Courier New', monospace;
      background-color: #f0f0f0;
      color: var(--primary-dark);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    
    .participant-card {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      background-color: #f8f9fa;
      transition: all 0.2s;
    }
    
    .participant-card:hover {
      background-color: #e9ecef;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 5px;
    }
    
    .user-name {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-container {
      height: 400px;
      overflow-y: auto;
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }
    
    .chat-header {
      background-color: var(--primary-dark);
      color: white;
      padding: 10px 15px;
      border-radius: 8px 8px 0 0;
      margin-bottom: 15px;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .message-bubble {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 18px;
      margin-bottom: 10px;
      position: relative;
    }
    
    .sent {
      background-color: #e3f2fd;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    
    .received {
      background-color: #f1f1f1;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    
    .message-time {
      font-size: 0.75rem;
      color: #6c757d;
      text-align: right;
      margin-top: 4px;
    }
    
    .message-sender {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--primary-dark);
    }
    
    .no-messages {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .view-btn {
      transition: all 0.2s;
    }
    
    .view-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(67, 97, 238, 0.2);
    }
    
    .tab-content {
      background-color: white;
      border-radius: 0 0 10px 10px;
      padding: 20px;
    }
    
    .nav-tabs .nav-link.active {
      background-color: white;
      border-bottom-color: white;
      color: var(--primary-dark);
      font-weight: 600;
    }
    
    .nav-tabs .nav-link {
      color: #6c757d;
      border: none;
      padding: 12px 20px;
    }
    
    .search-highlight {
      background-color: #fff9c4;
      padding: 0 2px;
    }
    /*** ends ici ***/
  </style>
</head>
<body>
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-11 col-xl-10 mx-auto">
      <!-- Header -->
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <div>
          <h4 class="fw-bold mb-1"><i class="fas fa-door-closed me-2"></i>Dark Messages</h4>
          <p class="text-muted mb-0">Monitor token-protected private conversations</p>
        </div>
        <div class="d-flex gap-2">
          <div class="input-group" style="width: 250px;">
            <input type="text" id="searchInput" class="form-control" placeholder="Search tokens or users...">
            <button class="btn btn-outline-secondary" id="searchBtn"><i class="fas fa-search"></i></button>
          </div>

          <form id="timeFilterForm" method="get">
            <select class="form-select" name="time_filter" id="timeFilter" style="width: auto;" onchange="this.form.submit()">
              <option value="all" {% if filter_value == 'all' %}selected{% endif %}>All Time</option>
              <option value="today" {% if filter_value == 'today' %}selected{% endif %}>Today</option>
              <option value="week" {% if filter_value == 'week' %}selected{% endif %}>Last 7 Days</option>
              <option value="month" {% if filter_value == 'month' %}selected{% endif %}>Last 30 Days</option>
            </select>
          </form>
        </div>
        <a href="{% url 'dashindex' %}" class="btn btn-outline-primary">
              <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </a>
      </div>

      <!-- Dark Rooms Table -->
      <div class="darkroom-card mb-4">
        <div class="darkroom-header mb-3">
          <h5 class="mb-0">Active Dark Rooms</h5>
        </div>
        <div class="table-responsive">
          <table class="table darkroom-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Token ID</th>
                <th>Participants</th>
                <th>Created</th>
                <th>Last Activity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for tunnel in page_obj %}
              <tr data-created="{{ tunnel.created_at|date:'Y-m-d H:i:s' }}">
                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                <td><span class="token-badge">{{ tunnel.tunnel_id }}</span></td>
                <td>
                  <div class="d-flex gap-3">
                    <div class="participant-card text-center">
                      <img src="{% if tunnel.initiator.userprofile.profile_picture %}{{ tunnel.initiator.userprofile.profile_picture.url }}{% else %}https://i.pravatar.cc/150?img=6{% endif %}" class="user-avatar">
                      <p class="user-name">{{ tunnel.initiator.username }}</p>
                    </div>
                    <div class="participant-card text-center">
                      <img src="{% if tunnel.recipient.userprofile.profile_picture %}{{ tunnel.recipient.userprofile.profile_picture.url }}{% else %}https://i.pravatar.cc/150?img=6{% endif %}" class="user-avatar">
                      <p class="user-name">{{ tunnel.recipient.username }}</p>
                    </div>
                  </div>
                </td>
                <td>{{ tunnel.created_at|date:"M d, Y H:i" }}</td>
                <td>{% if tunnel.is_active %}Active{% else %}Inactive{% endif %}</td>
                <td>
                  <button class="btn btn-sm btn-primary view-btn" type="button" data-tunnel="{{ tunnel.id }}">
                    <i class="fas fa-eye me-1"></i> View
                  </button>
                </td>
              </tr>

              <!-- Collapsible chat messages -->
              <tr class="chat-details" id="chatDetails{{ tunnel.id }}" style="display: none;">
                <td colspan="6" style="background-color: #f8f9fa; padding: 0;">
                  <div class="chat-container position-relative">
                    <div class="chat-header d-flex justify-content-between align-items-center px-3 py-2">
                      <div>
                        Token: <strong>{{ tunnel.tunnel_id }}</strong> 
                        ({{ tunnel.initiator.username }} ↔ {{ tunnel.recipient.username }})
                      </div>
                      <button class="btn btn-sm btn-danger close-chat" data-tunnel="{{ tunnel.id }}">
                        <i class="fas fa-times"></i> Close
                      </button>
                    </div>
                    {% if tunnel.messages.count %}
                      {% for msg in tunnel.messages.all %}
                        <div class="message-bubble {% if msg.sender == tunnel.initiator %}sent{% else %}received{% endif %}">
                          <div class="d-flex align-items-center mb-1">
                            <img src="{% if msg.sender.userprofile.profile_picture %}{{ msg.sender.userprofile.profile_picture.url }}{% else %}https://i.pravatar.cc/150?img=7{% endif %}" class="user-avatar me-2">
                            <div class="message-sender">{{ msg.sender.username }}{% if msg.receiver %} → {{ msg.receiver.username }}{% endif %}</div>
                          </div>
                          <p>{{ msg.content }}</p>
                          <div class="message-time">{{ msg.timestamp|date:"M d, Y H:i" }}</div>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="no-messages text-center py-3">
                        <i class="fas fa-comment-slash fa-2x mb-2"></i>
                        <h6>No Messages Found</h6>
                      </div>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center">No tunnels found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <!-- Pagination Controls -->
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-3">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?time_filter={{ filter_value }}&page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
              <li class="page-item"><a class="page-link" href="?time_filter={{ filter_value }}&page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?time_filter={{ filter_value }}&page={{ page_obj.next_page_number }}">Next</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>

    </div>
  </div>
</div>

<!-- popup box for Admin Authentication Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content shadow-lg border-0 rounded-4">
      
      <!-- Modal Header -->
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title fw-bold" id="passwordModalLabel">
          <i class="fas fa-user-shield me-2"></i>Admin Authentication
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-4">
        <p class="text-muted mb-3">Please enter your admin credentials to view this session.</p>
        <form id="passwordForm" class="needs-validation" novalidate>
          
          <!-- Username -->
          <div class="mb-3">
            <label for="adminUsername" class="form-label fw-semibold">Username</label>
            <input type="text" class="form-control form-control-lg rounded-3" id="adminUsername" placeholder="Enter username" required>
            <div class="invalid-feedback">Username is required.</div>
          </div>
          
          <!-- Password -->
          <div class="mb-3">
            <label for="adminPassword" class="form-label fw-semibold">Password</label>
            <input type="password" class="form-control form-control-lg rounded-3" id="adminPassword" placeholder="Enter password" required>
            <div class="invalid-feedback">Password is required.</div>
          </div>
          
          <!-- Error Message -->
          <div id="passwordError" class="text-danger fw-semibold mb-3" style="display:none;">
            <i class="fas fa-exclamation-triangle me-1"></i>Incorrect credentials! Try again.
          </div>
          
          <input type="hidden" id="tunnelId">
          
          <!-- Submit Button -->
          <button type="submit" class="btn btn-primary w-100 btn-lg rounded-3 fw-bold">
            <i class="fas fa-lock me-1"></i> Verify & View
          </button>
        </form>
      </div>
      
      <!-- Optional Footer -->
      <div class="modal-footer justify-content-center border-0 pb-3">
        <small class="text-muted">Your credentials are safe and encrypted.</small>
      </div>
      
    </div>
  </div>
</div>

<!-- Optional JS for Bootstrap form validation -->
<script>
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>


<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Search functionality -->
<script>
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const timeFilter = document.getElementById('timeFilter');

function filterSessions() {
  const term = searchInput.value.toLowerCase();
  const filterValue = timeFilter.value;
  const now = new Date();

  document.querySelectorAll('.darkroom-table tbody tr').forEach(row => {
    if (row.classList.contains('chat-details')) return; // skip chat rows

    const token = row.querySelector('.token-badge')?.textContent.toLowerCase() || '';
    const names = Array.from(row.querySelectorAll('.user-name')).map(el => el.textContent.toLowerCase()).join(' ');
    const createdStr = row.dataset.created;
    const rowDate = new Date(createdStr);

    // Search match
    const searchMatch = token.includes(term) || names.includes(term);

    // Time filter match
    let dateMatch = true;
    if (filterValue === 'today') {
      dateMatch = rowDate.toDateString() === now.toDateString();
    } else if (filterValue === 'week') {
      const weekAgo = new Date(now);
      weekAgo.setDate(now.getDate() - 7);
      dateMatch = rowDate >= weekAgo;
    } else if (filterValue === 'month') {
      const monthAgo = new Date(now);
      monthAgo.setDate(now.getDate() - 30);
      dateMatch = rowDate >= monthAgo;
    }

    // Show row only if both match
    row.style.display = (searchMatch && dateMatch) ? '' : 'none';
  });
}

// Search events
searchBtn.addEventListener('click', filterSessions);
searchInput.addEventListener('keyup', e => { if (e.key === 'Enter') filterSessions(); });

// Filter event (apply immediately)
timeFilter.addEventListener('change', filterSessions);

// Optional: filter initially on page load
filterSessions();
</script>


<!----close button in chat---->>
<script>
document.querySelectorAll('.close-chat').forEach(btn => {
  btn.addEventListener('click', () => {
    const tunnelId = btn.dataset.tunnel;
    document.getElementById(`chatDetails${tunnelId}`).style.display = 'none';
    currentlyOpenTunnel = null; // reset currently open tunnel
  });
});
</script>


<!-- Password modal & messages toggle -->
<script>
const passwordModal = document.getElementById('passwordModal');
const tunnelIdInput = document.getElementById('tunnelId');
const passwordForm = document.getElementById('passwordForm');
const passwordError = document.getElementById('passwordError');
let currentlyOpenTunnel = null;

// Handle View button click
document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tunnelId = btn.dataset.tunnel;

        // Hide previously open tunnel if any
        if (currentlyOpenTunnel && currentlyOpenTunnel !== tunnelId) {
            document.getElementById(`chatDetails${currentlyOpenTunnel}`).style.display = 'none';
        }

        // Set tunnel ID in modal hidden input
        tunnelIdInput.value = tunnelId;
        passwordError.style.display = 'none';
        passwordForm.reset();

        // Show password modal
        const modal = new bootstrap.Modal(passwordModal);
        modal.show();
    });
});

// Handle password verification
passwordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    const tunnelId = tunnelIdInput.value;

    const response = await fetch("{% url 'verify_admin_password' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ username, password })
    });

    const result = await response.json();

    if(result.success){
        // Close modal
        const modalInstance = bootstrap.Modal.getInstance(passwordModal);
        modalInstance.hide();

        // Show this tunnel messages
        const detailsRow = document.getElementById(`chatDetails${tunnelId}`);
        detailsRow.style.display = 'table-row';
        currentlyOpenTunnel = tunnelId;
    } else {
        passwordError.style.display = 'block';
    }
});

  //new js //
  // Sample data
    const darkRoomsData = [
      {
        id: 1,
        token: "XK-8943-JF12",
        participants: [
          { id: 1, name: "John Doe", avatar: "https://i.pravatar.cc/150?img=5" },
          { id: 2, name: "Jane Smith", avatar: "https://i.pravatar.cc/150?img=11" }
        ],
        created: "Today, 09:14",
        lastActivity: "2 mins ago",
        messages: [
          { sender: 1, text: "Did you get the documents I sent?", time: "Today, 09:15" },
          { sender: 2, text: "Yes, everything looks good. Let's proceed", time: "Today, 09:16" },
          { sender: 1, text: "Perfect. I'll transfer the funds tomorrow", time: "Today, 09:17" }
        ]
      },
      {
        id: 2,
        token: "PL-5621-KD34",
        participants: [
          { id: 3, name: "Alex Johnson", avatar: "https://i.pravatar.cc/150?img=3" },
          { id: 4, name: "Mike Brown", avatar: "https://i.pravatar.cc/150?img=8" }
        ],
        created: "Today, 10:30",
        lastActivity: "15 mins ago",
        messages: [
          { sender: 3, text: "Are we still meeting at the usual place?", time: "Today, 10:31" },
          { sender: 4, text: "Yes, 8pm. Don't be late this time", time: "Today, 10:33" },
          { sender: 3, text: "I'll be there. Bring the package", time: "Today, 10:34" }
        ]
      },
      {
        id: 3,
        token: "QW-7890-RT56",
        participants: [
          { id: 5, name: "Emma Wilson", avatar: "https://i.pravatar.cc/150?img=9" },
          { id: 2, name: "Jane Smith", avatar: "https://i.pravatar.cc/150?img=11" }
        ],
        created: "Yesterday, 22:15",
        lastActivity: "1 hour ago",
        messages: []
      },
      {
        id: 4,
        token: "MN-3456-TY78",
        participants: [
          { id: 2, name: "Jane Smith", avatar: "https://i.pravatar.cc/150?img=11" },
          { id: 6, name: "David Lee", avatar: "https://i.pravatar.cc/150?img=12" }
        ],
        created: "Today, 11:45",
        lastActivity: "30 mins ago",
        messages: [
          { sender: 2, text: "The documents are ready for review", time: "Today, 11:46" },
          { sender: 6, text: "I'll check them and get back to you", time: "Today, 11:50" }
        ]
      }
    ];

    // DOM elements
    const darkRoomsTable = document.getElementById('darkRoomsTable');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const timeFilter = document.getElementById('timeFilter');
    const topParticipants = document.getElementById('topParticipants');
    const newRoomsCount = document.getElementById('newRoomsCount');
    const messagesCount = document.getElementById('messagesCount');
    const activeRoomsCount = document.getElementById('activeRoomsCount');

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      renderDarkRooms(darkRoomsData);
      renderTopParticipants();
      updateStats();
    });

    // Render dark rooms table
    function renderDarkRooms(rooms) {
      darkRoomsTable.innerHTML = '';
      
      rooms.forEach((room, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td><span class="token-badge">${room.token}</span></td>
          <td>
            <div class="d-flex gap-3">
              ${room.participants.map(participant => `
                <div class="participant-card">
                  <img src="${participant.avatar}" class="user-avatar">
                  <p class="user-name">${participant.name}</p>
                </div>
              `).join('')}
            </div>
          </td>
          <td>${room.created}</td>
          <td>${room.lastActivity}</td>
          <td>
            <button class="btn btn-sm btn-primary view-btn" data-bs-toggle="collapse" data-bs-target="#chatDetails${room.id}">
              <i class="fas fa-eye me-1"></i> View
            </button>
          </td>
        `;
        
        const detailsRow = document.createElement('tr');
        detailsRow.className = 'collapse';
        detailsRow.id = `chatDetails${room.id}`;
        detailsRow.innerHTML = `
          <td colspan="6" style="background-color: #f8f9fa; padding: 0;">
            <div class="chat-container">
              <div class="chat-header">
                <strong>Token: ${room.token}</strong> 
                <span class="ms-2">(${room.participants.map(p => p.name).join(' ↔ ')})</span>
              </div>
              ${room.messages.length > 0 ? 
                room.messages.map(msg => {
                  const participant = room.participants.find(p => p.id === msg.sender);
                  return `
                    <div class="message-bubble ${index % 2 === 0 ? 'sent' : 'received'}">
                      <div class="message-sender">${participant.name}</div>
                      <p>${msg.text}</p>
                      <div class="message-time">${msg.time}</div>
                    </div>
                  `;
                }).join('') : `
                <div class="no-messages">
                  <i class="fas fa-comment-slash fa-2x mb-3"></i>
                  <h5>No Messages Found</h5>
                  <p class="text-muted">This dark room has no message history</p>
                </div>
              `}
            </div>
          </td>
        `;
        
        darkRoomsTable.appendChild(row);
        darkRoomsTable.appendChild(detailsRow);
      });
    }

    // Render top participants
    function renderTopParticipants() {
      // Count participant activity
      const participantCounts = {};
      darkRoomsData.forEach(room => {
        room.participants.forEach(participant => {
          if (!participantCounts[participant.id]) {
            participantCounts[participant.id] = {
              ...participant,
              count: 0
            };
          }
          participantCounts[participant.id].count++;
        });
      });

      // Sort by most active
      const sortedParticipants = Object.values(participantCounts)
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);

      // Render to DOM
      topParticipants.innerHTML = sortedParticipants.map(participant => `
        <div class="list-group-item border-0 d-flex align-items-center">
          <img src="${participant.avatar}" class="user-avatar me-3">
          <div class="flex-grow-1">
            <h6 class="mb-0">${participant.name}</h6>
            <small class="text-muted">${participant.count} active rooms</small>
          </div>
          <span class="badge bg-primary rounded-pill">${participant.count} today</span>
        </div>
      `).join('');
    }

    // Update statistics
    function updateStats() {
      const todayRooms = darkRoomsData.filter(room => room.created.includes('Today'));
      const totalMessages = darkRoomsData.reduce((sum, room) => sum + room.messages.length, 0);
      
      newRoomsCount.textContent = todayRooms.length;
      messagesCount.textContent = totalMessages;
      activeRoomsCount.textContent = darkRoomsData.filter(room => room.lastActivity.includes('min') || room.lastActivity.includes('hour')).length;
    }

    // Search functionality
    function performSearch() {
      const searchTerm = searchInput.value.toLowerCase();
      const timeFilterValue = timeFilter.value;
      
      let filteredRooms = darkRoomsData;
      
      // Apply time filter
      if (timeFilterValue === 'today') {
        filteredRooms = filteredRooms.filter(room => room.created.includes('Today'));
      } else if (timeFilterValue === 'week') {
        // In a real app, you'd have proper date filtering
        filteredRooms = filteredRooms.filter(room => 
          room.created.includes('Today') || 
          room.created.includes('Yesterday') ||
          room.created.includes('days ago')
        );
      } else if (timeFilterValue === 'month') {
        filteredRooms = filteredRooms; // Show all for this demo
      }
      
      // Apply search filter
      if (searchTerm) {
        filteredRooms = filteredRooms.filter(room => 
          room.token.toLowerCase().includes(searchTerm) ||
          room.participants.some(p => p.name.toLowerCase().includes(searchTerm))
        );
      }
      
      renderDarkRooms(filteredRooms);
      
      // Highlight search results
      if (searchTerm) {
        document.querySelectorAll('.user-name, .token-badge').forEach(el => {
          const text = el.textContent.toLowerCase();
          if (text.includes(searchTerm)) {
            const regex = new RegExp(searchTerm, 'gi');
            el.innerHTML = el.textContent.replace(regex, match => 
              `<span class="search-highlight">${match}</span>`
            );
          }
        });
      }
    }

    // Event listeners
    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('keyup', function(e) {
      if (e.key === 'Enter') performSearch();
    });
    timeFilter.addEventListener('change', performSearch);
</script>

</body>
</html>
